{"uid":"909a5228348a478d","name":"test_missing_device_data","fullName":"tests.test_data_in_tables#test_missing_device_data","historyId":"2bb1c061d37d1a7a447831eff1866625","time":{"start":1731084436764,"stop":1731084438375,"duration":1611},"description":"\nTests the presence of corresponding entries in the device_segments table for each record in the agg_data table, \nensuring data integrity between apps and devices.\n","descriptionHtml":"<p>Tests the presence of corresponding entries in the device_segments table for each record in the agg_data table,<br />\nensuring data integrity between apps and devices.</p>\n","status":"failed","statusMessage":"AssertionError: Found records in agg_data without matching device models in device_segments:\n  App ID: 32110, Device Model: iphone 7, App Name: gs_as, Platform: as\n  App ID: 31885, Device Model: iphone 7, App Name: hs_as, Platform: as\n  App ID: 31885, Device Model: None, App Name: hs_as, Platform: as\n  App ID: 31885, Device Model: iphone 13, App Name: hs_as, Platform: as\n  App ID: 32116, Device Model: None, App Name: fd_gp, Platform: gp\n  App ID: 32116, Device Model: iphone 7, App Name: fd_gp, Platform: gp\nassert not [(32110, 'iphone 7', 'gs_as', 'as'), (31885, 'iphone 7', 'hs_as', 'as'), (31885, None, 'hs_as', 'as'), (31885, 'iphone 13', 'hs_as', 'as'), (32116, None, 'fd_gp', 'gp'), (32116, 'iphone 7', 'fd_gp', 'gp')]","statusTrace":"setup = (<google.cloud.bigquery.client.Client object at 0x7f1b5a95a810>, <environment.Environment object at 0x7f1b58db37a0>)\n\n    @allure.story('Data_Tables_Creation')\n    @allure.severity(allure.severity_level.NORMAL)\n    @allure.description(\"\"\"\n    Tests the presence of corresponding entries in the device_segments table for each record in the agg_data table,\n    ensuring data integrity between apps and devices.\n    \"\"\")\n    def test_missing_device_data(setup):\n        \"\"\"\n        Verifies the presence of corresponding entries in the device_segments table for each record in the agg_data table.\n        \"\"\"\n        bq_client, env = setup\n        agg_data = env.get_full_table_id('agg_data')\n        app_names = env.get_full_table_id('app_names')\n        device_segments = env.get_full_table_id('device_segments')\n    \n        query = f\"\"\"\n            -- Select data about apps and device models\n            SELECT agg.app_id, agg.device_model, an.app_name, an.platform\n            -- From the agg_data table using the alias 'agg'\n            FROM `{agg_data}` agg\n            -- Join the app_names table using the alias 'an' by app_id\n            JOIN `{app_names}` an ON agg.app_id = an.app_id\n            -- Left join with the device_segments table using the alias 'ds' by device model, case insensitive\n            LEFT JOIN `{device_segments}` ds ON UPPER(agg.device_model) = UPPER(ds.device_model)\n                -- Also check for matching app name and platform between app_names and device_segments\n                AND an.app_name = ds.app_short AND an.platform = ds.platform\n            -- Condition to select records that do not have a corresponding device model in device_segments\n            WHERE ds.device_model IS NULL\n        \"\"\"\n    \n        results = execute_query_and_log(bq_client, query, \"Finding unmatched data in device_segments\",\n                                        include_query_in_message=False)\n    \n        failed_items = [(row.app_id, row.device_model, row.app_name, row.platform) for row in results]\n    \n        with allure.step(\"Verifying the absence of records without matching device models in device_segments\"):\n>           assert not failed_items, \"Found records in agg_data without matching device models in device_segments:\\n\" + \\\n                                     \"\\n\".join(\n                                         f\"App ID: {app_id}, Device Model: {device_model}, App Name: {app_name}, Platform: {platform}\"\n                                         for app_id, device_model, app_name, platform in failed_items)\nE           AssertionError: Found records in agg_data without matching device models in device_segments:\nE             App ID: 32110, Device Model: iphone 7, App Name: gs_as, Platform: as\nE             App ID: 31885, Device Model: iphone 7, App Name: hs_as, Platform: as\nE             App ID: 31885, Device Model: None, App Name: hs_as, Platform: as\nE             App ID: 31885, Device Model: iphone 13, App Name: hs_as, Platform: as\nE             App ID: 32116, Device Model: None, App Name: fd_gp, Platform: gp\nE             App ID: 32116, Device Model: iphone 7, App Name: fd_gp, Platform: gp\nE           assert not [(32110, 'iphone 7', 'gs_as', 'as'), (31885, 'iphone 7', 'hs_as', 'as'), (31885, None, 'hs_as', 'as'), (31885, 'iphone 13', 'hs_as', 'as'), (32116, None, 'fd_gp', 'gp'), (32116, 'iphone 7', 'fd_gp', 'gp')]\n\ntests/test_data_in_tables.py:83: AssertionError","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"setup","time":{"start":1731084434898,"stop":1731084434899,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"testStage":{"description":"\nTests the presence of corresponding entries in the device_segments table for each record in the agg_data table, \nensuring data integrity between apps and devices.\n","status":"failed","statusMessage":"AssertionError: Found records in agg_data without matching device models in device_segments:\n  App ID: 32110, Device Model: iphone 7, App Name: gs_as, Platform: as\n  App ID: 31885, Device Model: iphone 7, App Name: hs_as, Platform: as\n  App ID: 31885, Device Model: None, App Name: hs_as, Platform: as\n  App ID: 31885, Device Model: iphone 13, App Name: hs_as, Platform: as\n  App ID: 32116, Device Model: None, App Name: fd_gp, Platform: gp\n  App ID: 32116, Device Model: iphone 7, App Name: fd_gp, Platform: gp\nassert not [(32110, 'iphone 7', 'gs_as', 'as'), (31885, 'iphone 7', 'hs_as', 'as'), (31885, None, 'hs_as', 'as'), (31885, 'iphone 13', 'hs_as', 'as'), (32116, None, 'fd_gp', 'gp'), (32116, 'iphone 7', 'fd_gp', 'gp')]","statusTrace":"setup = (<google.cloud.bigquery.client.Client object at 0x7f1b5a95a810>, <environment.Environment object at 0x7f1b58db37a0>)\n\n    @allure.story('Data_Tables_Creation')\n    @allure.severity(allure.severity_level.NORMAL)\n    @allure.description(\"\"\"\n    Tests the presence of corresponding entries in the device_segments table for each record in the agg_data table,\n    ensuring data integrity between apps and devices.\n    \"\"\")\n    def test_missing_device_data(setup):\n        \"\"\"\n        Verifies the presence of corresponding entries in the device_segments table for each record in the agg_data table.\n        \"\"\"\n        bq_client, env = setup\n        agg_data = env.get_full_table_id('agg_data')\n        app_names = env.get_full_table_id('app_names')\n        device_segments = env.get_full_table_id('device_segments')\n    \n        query = f\"\"\"\n            -- Select data about apps and device models\n            SELECT agg.app_id, agg.device_model, an.app_name, an.platform\n            -- From the agg_data table using the alias 'agg'\n            FROM `{agg_data}` agg\n            -- Join the app_names table using the alias 'an' by app_id\n            JOIN `{app_names}` an ON agg.app_id = an.app_id\n            -- Left join with the device_segments table using the alias 'ds' by device model, case insensitive\n            LEFT JOIN `{device_segments}` ds ON UPPER(agg.device_model) = UPPER(ds.device_model)\n                -- Also check for matching app name and platform between app_names and device_segments\n                AND an.app_name = ds.app_short AND an.platform = ds.platform\n            -- Condition to select records that do not have a corresponding device model in device_segments\n            WHERE ds.device_model IS NULL\n        \"\"\"\n    \n        results = execute_query_and_log(bq_client, query, \"Finding unmatched data in device_segments\",\n                                        include_query_in_message=False)\n    \n        failed_items = [(row.app_id, row.device_model, row.app_name, row.platform) for row in results]\n    \n        with allure.step(\"Verifying the absence of records without matching device models in device_segments\"):\n>           assert not failed_items, \"Found records in agg_data without matching device models in device_segments:\\n\" + \\\n                                     \"\\n\".join(\n                                         f\"App ID: {app_id}, Device Model: {device_model}, App Name: {app_name}, Platform: {platform}\"\n                                         for app_id, device_model, app_name, platform in failed_items)\nE           AssertionError: Found records in agg_data without matching device models in device_segments:\nE             App ID: 32110, Device Model: iphone 7, App Name: gs_as, Platform: as\nE             App ID: 31885, Device Model: iphone 7, App Name: hs_as, Platform: as\nE             App ID: 31885, Device Model: None, App Name: hs_as, Platform: as\nE             App ID: 31885, Device Model: iphone 13, App Name: hs_as, Platform: as\nE             App ID: 32116, Device Model: None, App Name: fd_gp, Platform: gp\nE             App ID: 32116, Device Model: iphone 7, App Name: fd_gp, Platform: gp\nE           assert not [(32110, 'iphone 7', 'gs_as', 'as'), (31885, 'iphone 7', 'hs_as', 'as'), (31885, None, 'hs_as', 'as'), (31885, 'iphone 13', 'hs_as', 'as'), (32116, None, 'fd_gp', 'gp'), (32116, 'iphone 7', 'fd_gp', 'gp')]\n\ntests/test_data_in_tables.py:83: AssertionError","steps":[{"name":"Finding unmatched data in device_segments","time":{"start":1731084436764,"stop":1731084438374,"duration":1610},"status":"passed","steps":[],"attachments":[{"uid":"b61a6c3013dfb289","name":"SQL Query","source":"b61a6c3013dfb289.txt","type":"text/plain","size":950},{"uid":"15030e3b1e30caef","name":"SQL Results","source":"15030e3b1e30caef.json","type":"application/json","size":759}],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":2,"hasContent":true,"attachmentStep":false},{"name":"Verifying the absence of records without matching device models in device_segments","time":{"start":1731084438374,"stop":1731084438375,"duration":1},"status":"failed","statusMessage":"AssertionError: Found records in agg_data without matching device models in device_segments:\n  App ID: 32110, Device Model: iphone 7, App Name: gs_as, Platform: as\n  App ID: 31885, Device Model: iphone 7, App Name: hs_as, Platform: as\n  App ID: 31885, Device Model: None, App Name: hs_as, Platform: as\n  App ID: 31885, Device Model: iphone 13, App Name: hs_as, Platform: as\n  App ID: 32116, Device Model: None, App Name: fd_gp, Platform: gp\n  App ID: 32116, Device Model: iphone 7, App Name: fd_gp, Platform: gp\nassert not [(32110, 'iphone 7', 'gs_as', 'as'), (31885, 'iphone 7', 'hs_as', 'as'), (31885, None, 'hs_as', 'as'), (31885, 'iphone 13', 'hs_as', 'as'), (32116, None, 'fd_gp', 'gp'), (32116, 'iphone 7', 'fd_gp', 'gp')]\n","statusTrace":"  File \"/tests_project/tests/test_data_in_tables.py\", line 83, in test_missing_device_data\n    assert not failed_items, \"Found records in agg_data without matching device models in device_segments:\\n\" + \\\n","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":true,"stepsCount":0,"attachmentsCount":0,"hasContent":true,"attachmentStep":false}],"attachments":[],"parameters":[],"shouldDisplayMessage":true,"stepsCount":2,"attachmentsCount":2,"hasContent":true,"attachmentStep":false},"afterStages":[],"labels":[{"name":"severity","value":"normal"},{"name":"story","value":"Data_Tables_Creation"},{"name":"parentSuite","value":"tests"},{"name":"suite","value":"test_data_in_tables"},{"name":"host","value":"27ca6fce9de0"},{"name":"thread","value":"1-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.test_data_in_tables"},{"name":"resultFormat","value":"allure2"}],"parameters":[],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[],"flaky":false}],"tags":[]},"source":"909a5228348a478d.json","parameterValues":[]}